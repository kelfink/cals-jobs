------------------------------------------------------------------------------------
-- SQL PROCEDURE FOR FINDING THE CLIENT COUNTY AND INSERT/UPDATE CLIENT_CNTY TABLE  
-- Created on: 10/03/2017                          
-- AUTHOR: TPT1 TEAM
------------------------------------------------------------------------------------
CREATE OR REPLACE PROCEDURE CWSRS1.GENCLNCNTY
(
IN PARM_CRUD CHAR(1),    	-- 'O' = ONE TIME LOAD,  'I' = INSERT, 'U' = UPDATE
IN PARM_ID CHAR(10), 		-- REFERAL OR CASE OR CLIENT IDENTIFIER
IN PARM_TRIGTBL CHAR(4),  	-- TRIGGERING TABLE: 'REFR' FOR REFERL_T, 'CASE' FOR CASE_T, 'CLNT' FOR CLIENT_T
OUT RETCODE INTEGER			-- SQLCODE RETURNED FROM THE PROCEDURE
)
LANGUAGE SQL
P1: BEGIN
	DECLARE CLIENTID CHAR(10);    
	DECLARE END_TABLE INT DEFAULT 0; 
	DECLARE CNTYCD SMALLINT DEFAULT 0;
	DECLARE COMPCNTY SMALLINT DEFAULT 0;
	DECLARE SQLCODE INTEGER DEFAULT 0;
	DECLARE SQLRETN INTEGER DEFAULT 0;
	DECLARE CLTPRESIND CHAR(1) DEFAULT 'N';
	DECLARE CNTYRULE CHAR(25) DEFAULT '';
--  DECLARE CURSORS	
	DECLARE CLNTT CURSOR FOR          
		SELECT IDENTIFIER 
		  FROM CWSRS1.CLIENT_T 
		 ORDER BY IDENTIFIER
		   FOR FETCH ONLY
		  WITH UR;  
	DECLARE REFTRIG CURSOR FOR
		SELECT IDENTIFIER 
		  FROM CWSRS1.CLIENT_T A, CWSRS1.REFR_CLT B 
		 WHERE A.IDENTIFIER = B.FKCLIENT_T
		   AND B.FKREFERL_T = PARM_ID
		 ORDER BY IDENTIFIER
		   FOR FETCH ONLY
		  WITH UR; 	
	DECLARE CASTRIG CURSOR FOR		  
		SELECT B.IDENTIFIER 
		  FROM CWSRS1.CLIENT_T A, CWSRS1.CASE_T B 
		 WHERE A.IDENTIFIER = B.FKCHLD_CLT
		   AND B.IDENTIFIER = PARM_ID
		 ORDER BY IDENTIFIER
		   FOR FETCH ONLY
		  WITH UR;	
	DECLARE ACTCASE CURSOR FOR
		SELECT GVR_ENTC 
		  FROM CWSRS1.CASE_T 
		 WHERE FKCHLD_CLT = CLIENTID 
		   AND END_DT IS NULL
		   FOR FETCH ONLY
		  WITH UR; 
	DECLARE ACTREFRL CURSOR FOR		
		SELECT GVR_ENTC 
		  FROM CWSRS1.REFERL_T A, CWSRS1.REFR_CLT B 
		 WHERE A.IDENTIFIER = B.FKREFERL_T 
		   AND FKCLIENT_T = CLIENTID 
		   AND REFCLSR_DT IS NULL
		 ORDER BY REF_RCV_DT DESC
		   FOR FETCH ONLY
		  WITH UR;  
	DECLARE CLOCASE CURSOR FOR          
		SELECT GVR_ENTC 
		  FROM CWSRS1.CASE_T 
		 WHERE FKCHLD_CLT = CLIENTID 
		   AND END_DT IS NOT NULL
		   FOR FETCH ONLY
		  WITH UR; 
	DECLARE CLOREFRL CURSOR FOR		
		SELECT GVR_ENTC 
		  FROM CWSRS1.REFERL_T A, CWSRS1.REFR_CLT B 
		 WHERE A.IDENTIFIER = B.FKREFERL_T 
		   AND FKCLIENT_T = CLIENTID 
		   AND REFCLSR_DT IS NOT NULL
		 ORDER BY REF_RCV_DT DESC
		   FOR FETCH ONLY
		  WITH UR;  		
	DECLARE ACTRELC CURSOR FOR		
		SELECT GVR_ENTC 
		  FROM CWSRS1.CASE_T A, CWSRS1.CLN_RELT B 
		 WHERE (B.FKCLIENT_0 = CLIENTID 
		    OR  B.FKCLIENT_T = CLIENTID) 
		   AND (A.FKCHLD_CLT = B.FKCLIENT_T
		    OR  A.FKCHLD_CLT = B.FKCLIENT_0)
		   AND  A.END_DT IS NULL 
		   FOR FETCH ONLY
		  WITH UR; 
	DECLARE CLORELC CURSOR FOR		
		SELECT GVR_ENTC 
		  FROM CWSRS1.CASE_T A, CWSRS1.CLN_RELT B 
		 WHERE (B.FKCLIENT_0 = CLIENTID 
		    OR  B.FKCLIENT_T = CLIENTID) 
		   AND (A.FKCHLD_CLT = B.FKCLIENT_T
		    OR  A.FKCHLD_CLT = B.FKCLIENT_0)
		   AND  A.END_DT IS NOT NULL 
		   FOR FETCH ONLY
		  WITH UR; 		
					
--  DECLARE HANDLERS		            
	DECLARE CONTINUE HANDLER FOR NOT FOUND      
	SET END_TABLE = 1; 
	DECLARE EXIT HANDLER FOR SQLEXCEPTION 
	SET RETCODE = SQLCODE;    
--  PARM_CRUD: 'O' = ONE TIME LOAD,  'I' = INSERT, 'U' = UPDATE  
	CASE PARM_CRUD
		WHEN 'O' THEN
			OPEN CLNTT;
			FETCH CLNTT INTO CLIENTID;
		WHEN 'I' THEN	
			IF PARM_TRIGTBL = 'REFR' THEN
				OPEN REFTRIG;
				FETCH REFTRIG INTO CLIENTID; 
		    ELSEIF PARM_TRIGTBL = 'CASE' THEN	
		    	OPEN CASTRIG;
				FETCH CASTRIG INTO CLIENTID; 
			ELSEIF PARM_TRIGTBL = 'CLNT' THEN	
				INSERT INTO CWSRS1.CLIENT_CNTY (CLIENT_ID,GVR_ENTC,LST_UPD_OP,LST_UPD_TS,CNTY_RULE)
				VALUES(PARM_ID, CNTYCD, 'I', CURRENT_TIMESTAMP, CNTYRULE);
				SET END_TABLE = 1;	
			END IF;		
		WHEN 'U' THEN	
			IF PARM_TRIGTBL = 'REFR' THEN
				OPEN REFTRIG;
				FETCH REFTRIG INTO CLIENTID; 
		    ELSEIF PARM_TRIGTBL = 'CASE' THEN	
		    	OPEN CASTRIG;
				FETCH CASTRIG INTO CLIENTID; 	
			END IF;	
		ELSE
			SET END_TABLE = 1;			
	END CASE;
	          
	WHILE END_TABLE = 0 DO       
		GETCNTY: LOOP 

			OPEN ACTCASE; 
			FETCH ACTCASE INTO CNTYCD; 
 			IF CNTYCD > 0 THEN 
 				SET CNTYRULE = 'ACTIVE_CLIENT_CASE';
 				CLOSE ACTCASE;
 				LEAVE GETCNTY;
 		    ELSE		
 				CLOSE ACTCASE;
  			END IF;  

			OPEN ACTREFRL; 
			FETCH ACTREFRL INTO CNTYCD;   
			IF CNTYCD > 0 THEN 
				SET CNTYRULE = 'ACTIVE_CLIENT_REFERRAL';
				CLOSE ACTREFRL;
				LEAVE GETCNTY;
 		    ELSE		
 				CLOSE ACTREFRL;				
  			END IF;  
  			
 			  		
  			OPEN CLOCASE; 
			FETCH CLOCASE INTO CNTYCD; 
 			IF CNTYCD > 0 THEN 
 				SET CNTYRULE = 'CLOSED_CLIENT_CASE';
 				CLOSE CLOCASE;
 				LEAVE GETCNTY;
 		    ELSE		
 				CLOSE CLOCASE; 				
  			END IF;  

			OPEN CLOREFRL; 
			FETCH CLOREFRL INTO CNTYCD;   
			IF CNTYCD > 0 THEN 
				SET CNTYRULE = 'CLOSED_CLIENT_REFERRAL';
				CLOSE CLOREFRL;
				LEAVE GETCNTY;
 		    ELSE		
 				CLOSE CLOREFRL; 				
  			END IF;  
  			
  			OPEN ACTRELC; 
			FETCH ACTRELC INTO CNTYCD; 
 			IF CNTYCD > 0 THEN 
 				SET CNTYRULE = 'ACTIVE_RELATED_CASE';
 				CLOSE ACTRELC;
 				LEAVE GETCNTY;
 		    ELSE		
 				CLOSE ACTRELC; 				
  			END IF;  

			OPEN CLORELC; 
			FETCH CLORELC INTO CNTYCD; 
			IF CNTYCD > 0 THEN 
				SET CNTYRULE = 'CLOSED_RELATED_CASE'; 
			END IF; 
			CLOSE CLORELC;
			LEAVE GETCNTY;
		 
		END LOOP;
		
		CASE PARM_CRUD
			WHEN 'O' THEN
				INSERT INTO CWSRS1.CLIENT_CNTY (CLIENT_ID,GVR_ENTC,LST_UPD_OP,LST_UPD_TS,CNTY_RULE)
				VALUES(CLIENTID, CNTYCD, 'I', CURRENT_TIMESTAMP, CNTYRULE);
				SET END_TABLE = 0;
				SET CNTYCD = 0;
				SET CNTYRULE = '';
				FETCH CLNTT INTO CLIENTID;	
			WHEN 'I' THEN	
				SET END_TABLE = 0;
				SELECT GVR_ENTC  INTO  COMPCNTY  FROM CWSRS1.CLIENT_CNTY WHERE CLIENT_ID = CLIENTID;
				IF END_TABLE = 0 THEN 
					IF COMPCNTY <> CNTYCD THEN
				    	UPDATE CWSRS1.CLIENT_CNTY
				       	SET GVR_ENTC = CNTYCD,
				            LST_UPD_OP = 'U',
				            LST_UPD_TS = CURRENT_TIMESTAMP
				     	WHERE  CLIENT_ID = CLIENTID; 
				     END IF; 
				     SET CLTPRESIND = 'N';    
				ELSE
					INSERT INTO CWSRS1.CLIENT_CNTY (CLIENT_ID,GVR_ENTC,LST_UPD_OP,LST_UPD_TS,CNTY_RULE)
					VALUES(CLIENTID, CNTYCD, 'I', CURRENT_TIMESTAMP, CNTYRULE);
			    END IF;	
			    
			    SET CNTYCD = 0;	
			    SET END_TABLE = 0;	
			    SET CNTYRULE = '';
				IF PARM_TRIGTBL = 'REFR' THEN
					FETCH REFTRIG INTO CLIENTID; 
		    	ELSEIF PARM_TRIGTBL = 'CASE' THEN	
					FETCH CASTRIG INTO CLIENTID; 	
				END IF;	
			WHEN 'U' THEN	
				SET END_TABLE = 0;
				SELECT GVR_ENTC  INTO  COMPCNTY  FROM CWSRS1.CLIENT_CNTY WHERE CLIENT_ID = CLIENTID;
				IF END_TABLE = 0 THEN 
 					IF COMPCNTY <> CNTYCD THEN
				    	UPDATE CWSRS1.CLIENT_CNTY
				       	SET GVR_ENTC = CNTYCD,
				            LST_UPD_OP = 'U',
				            LST_UPD_TS = CURRENT_TIMESTAMP
				     	WHERE  CLIENT_ID = CLIENTID; 
				     END IF; 
				     SET CLTPRESIND = 'N';    
				ELSE
					INSERT INTO CWSRS1.CLIENT_CNTY (CLIENT_ID,GVR_ENTC,LST_UPD_OP,LST_UPD_TS,CNTY_RULE)
					VALUES(CLIENTID, CNTYCD, 'I', CURRENT_TIMESTAMP, CNTYRULE);
			    END IF;	
			    
			    SET CNTYCD = 0;	
			    SET END_TABLE = 0;
			    SET CNTYRULE = '';
				IF PARM_TRIGTBL = 'REFR' THEN
					FETCH REFTRIG INTO CLIENTID; 
		    	ELSEIF PARM_TRIGTBL = 'CASE' THEN	
					FETCH CASTRIG INTO CLIENTID; 	
				END IF;	
		END CASE;
		
 	END WHILE;
	CLOSE CLNTT;
END P1